<!DOCTYPE html>
<html>
<title>W3.CSS Template</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<style>
body,h1 {font-family: "Raleway", sans-serif}
body, html {height: 100%}
.bgimg {
  background-image: url('https://www.w3schools.com/w3images/forestbridge.jpg');
  min-height: 100%;
  background-position: center;
  background-size: cover;
}

#outputElement {
  max-height: 200px;
  width: 50%;
  overflow-y: scroll;
}

</style>
<body>

<div class="bgimg w3-display-container w3-animate-opacity w3-text-white">
  <div class="w3-display-topleft w3-padding-large w3-xlarge">
    Logo
  </div>
  <div class="w3-display-middle">
    <h1 class="w3-jumbo w3-animate-top">COMING SOON</h1>
    <hr class="w3-border-grey" style="margin:auto;width:40%">
    <h1 id='inputElement'>The input element</h1>

    <form onsubmit=makeLineItemList()>
        <label for="fname">First name:</label>
        <input type="text" id="fname" name="fname"><br><br>
        <label for="lname">Last name:</label>
        <input type="text" id="lname" name="lname"><br><br>
    </form>
    <button onClick =makeLineItemList()>SUBMIT</button>
    <p id='outputElement'></p>
  </div>
  <div class="w3-display-bottomleft w3-padding-large">
    Powered by <a href="https://www.w3schools.com/w3css/default.asp" target="_blank">w3.css</a>
  </div>
</div>

</body>

</html>

    <script src="./token.js"></script>
    <script src="./apiRequests.js"></script>
    <script>

    var estimateIDs = [];
    var dateFrom = Date.now() - 1209600000; //1 week ago 604800000 // 2 week ago 1209600000
    var dateTo = Date.now();
    var storeID = 2356;

    const isInDate = (estimate) => {
      const estimateDate = Date.parse(estimate.created_at);
      if (estimateDate <= dateTo && estimateDate >= dateFrom) {
        return true;
      }else {
        return false;
      }
    }

    const getIDs = async (estimates) => {
      let estimatesArr = estimates.estimates;
      const getMatch = (item) => {
        if (item.location_id === storeID && isInDate(item) ){
          estimateIDs.push(item.id);
        }
      }

      let lastEstimateOnPageDate = Date.parse(estimatesArr[estimatesArr.length - 1].created_at);
      let count = 2;

      while (lastEstimateOnPageDate <= dateTo && lastEstimateOnPageDate >= dateFrom){
        const nextPage = await getGivenPageEstimates(count);
        estimatesArr = estimatesArr.concat(nextPage.estimates);
        lastEstimateOnPageDate = Date.parse(nextPage.estimates[nextPage.estimates.length - 1].created_at);
        count++;
      }
      
      estimatesArr.forEach(getMatch);
      return estimateIDs;
    }
    
    const makeEstimateIdList = () => {
      return new Promise (async resolve => {
        const estimateIdList = await getPage1Estimates().then(estimates => getIDs(estimates));
        resolve(estimateIdList);
      })
    };
      
    const getLineItems = async () => {
      const estimateIdList = await makeEstimateIdList();
      const estimateLineItems = estimateIdList.map( id => getLineItemsFromEstimate(id));
      let lineItemsList = [];
      for (let i = 0; i < estimateLineItems.length; i++) {
        let lineItems = await estimateLineItems[i];
        for (let i = 0; i < lineItems.length; i++) {
          lineItemsList.push(lineItems[i].item);
        }
      }
      const merged = [].concat(lineItemsList);
      return merged;
    }

    const makeLineItemList = async () => {
      estimateIDs = [];

      const printStuff = async () => {
        const result = await getLineItems();
        result.forEach(item => {
          document.getElementById("outputElement").innerHTML += `${item}<br>`;
        })
        
      };
      printStuff();
    }
      
  </script> 


